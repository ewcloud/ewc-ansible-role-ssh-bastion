---

stages:
  - lint
  - release

variables:
  ANSIBLE_LINT_VERSION: 0.79.0
  NODE_VERSION: 22.16.0-bookworm-slim

# Linting with ansible-lint
ansible-lint:
  image: registry.gitlab.com/pipeline-components/ansible-lint:${ANSIBLE_LINT_VERSION}
  stage: lint
  script:
    - ansible-lint --offline .
  rules:
    - if: $CI_COMMIT_TAG || $CI_COMMIT_TITLE =~ /^chore.*/
      when: never
    - changes:
      - "**/*.yml"
  tags:
    - ewc

# Automated CHANGELOG.md generation from Conventional Commits history and git tag for release
semantic-release-tag:
  image: node:${NODE_VERSION}
  stage: release
  script:
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates
    - git config --global --add safe.directory /builds/HP-EWC/ewc-community-hub/ewcloud/ewc-ansible-role-ssh-bastion
    - npm install -g semantic-release @semantic-release/gitlab @semantic-release/changelog conventional-changelog-conventionalcommits @semantic-release/commit-analyzer @semantic-release/git
    - semantic-release -t "\${version}"
  rules:
    - if: $CI_COMMIT_TAG || $CI_COMMIT_TITLE =~ /^chore.*/
      when: never
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "merge_request_event"'
      changes:
        - "**/*.yml"
  tags: 
    - ewc
